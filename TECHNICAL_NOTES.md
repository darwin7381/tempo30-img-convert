# 技術筆記

## 專案概述

圖片風格轉換工具 - 將人物照片轉換為向量插畫風格（半寫實企業頭像 + 透明背景）

## 技術棧

- **後端**：Python + FastAPI + WebSocket
- **前端**：純 HTML/CSS/JavaScript
- **AI**：Google Gemini（2.0 Flash + 3 Pro Image）
- **圖片處理**：PIL, rembg, numpy
- **包管理**：uv（比 pip 快 10-100 倍）

## 啟動方式

```bash
./run.sh
# 或
uv run python app.py
```

服務會自動尋找可用端口（8000, 8001, 8002...）

## 完整處理流程

### 真人照片（7個步驟）
```
1. 【AI】分析圖片類型（Gemini 2.0 Flash，~3秒）
2. 【程式】圖片預處理（~5-8秒）
   ├─ 2.1 rembg 去背（u2net 模型）
   └─ 2.2 裁切平整底部（numpy）
3. 【AI】風格轉換（~30秒，最耗時）
   ├─ 3.1 分析身體範圍（Gemini 2.0 Flash）
   ├─ 3.2 生成向量插畫（Gemini 3 Pro Image）
   └─ 3.3 白色轉透明（numpy 連通區域分析，閾值240）
4. 【程式】最終處理（~2秒）
   ├─ 4.1 統一尺寸到 1000x1000（頭部比例35%）
   └─ 4.2 水平底部裁切（numpy）
```

### 像素插畫（6個步驟）
```
1. 【AI】分析圖片類型
2. 【程式】格式轉換（RGBA）
3. 【AI】風格轉換
   ├─ 3.1 分析身體範圍
   ├─ 3.2 生成向量插畫
   └─ 3.3 白色轉透明
4. 【程式】統一尺寸（無步驟 4.2）
```

## 進度分配策略

基於實際耗時的進度分配：
- 步驟1（AI 分析）：5%
- 步驟2（預處理）：10%
- **步驟3（AI 生成）：75%** ← 超級耗時
- 步驟4（最終處理）：10%

步驟3內部細分：
- 3.1 分析身體：10%（快速）
- 3.2 AI 生成：80%（超慢）
- 3.3 轉透明：10%（快速）

## 重要發現

### ⚠️ API 重複調用問題
- 步驟1：`analyze_image_type()` 調用 Gemini
- 步驟3.1：`analyze_image()` 又調用 Gemini
- **浪費 33% API 配額！**
- 優化方案：步驟1調用一次，將結果傳給後續步驟

### 身體範圍分類
1. HEAD_ONLY - 只有臉/頭部
2. HEAD_NECK - 頭部+脖子
3. HEAD_CHEST - 頭部到上胸部
4. FULL_BODY - 腰部以下可見

## 前端設計

### 為何選 FastAPI

| 需求 | Gradio | FastAPI |
|------|--------|---------|
| 動態步驟數 | ❌ 固定 | ✅ 完全動態 |
| 子步驟顯示 | ❌ 困難 | ✅ 容易 |
| 狀態疊加圖片 | ❌ 不可能 | ✅ CSS overlay |
| 橘色閃爍 | ❌ 無法關閉 | ✅ 無 |
| 布局控制 | ❌ 受限 | ✅ 完全自由 |
| 擴展性 | 2/10 | 10/10 |

### 界面布局

```
┌────────────────────────────────────────┐
│ 左側：上傳       │ 右側：結果+步驟    │
│ [圖片框 450px] ✕│ [結果框 500px] 📥 │
│ [開始轉換按鈕]   │ [動態步驟列表]     │
└────────────────────────────────────────┘
                    ↓
        [進度條 Fixed 在底部]
```

### 關鍵技術點

1. **圖片顯示**：`object-fit: contain`（完整顯示，保持比例）
2. **透明背景顯示**：棋盤格背景（像 Photoshop）
3. **狀態疊加**：CSS `position: absolute` overlay
4. **動態步驟**：WebSocket 發送步驟列表，前端動態創建
5. **自動端口**：socket 檢測可用端口

## 配置

### 環境變數（.env）
```
GEMINI_API_KEY=your_key_here
```

### API 配置（src/config.py）
- 圖像模型：gemini-3-pro-image-preview
- 文本模型：gemini-2.0-flash
- 最大重試：3 次
- 使用網關：False（直接用 Gemini SDK）

## 常見問題

### 中文顯示問題
使用支持中文的字體：PingFang > Songti > STHeiti

### 端口被佔用
自動尋找可用端口，從 8000 開始

### API 配額限制
- 每個圖片消耗 3 次 API 調用
- 建議優化：合併步驟1和3.1（節省33%）

## 檔案結構

```
├── app.py                      # FastAPI 後端
├── templates/
│   └── index.html             # 前端界面
├── src/
│   ├── config.py              # 配置
│   ├── gemini_client.py       # AI 客戶端
│   ├── image_processor.py     # 圖片處理
│   ├── style_converter.py     # 風格轉換核心
│   ├── prompts.py             # AI 提示詞
│   └── utils.py               # 工具函數
├── app_Gradio.py              # Gradio 版本備份
├── main.py                    # 命令行工具
└── pyproject.toml             # uv 專案配置
```

## 下一步優化建議

1. **消除重複 API 調用**（P0）- 節省 33% 配額
2. **添加錯誤重試機制的前端顯示**（P1）
3. **支持批量處理**（P2）
4. **添加多種風格選擇**（P3）

## 備註

- Gradio 版本已備份為 `app_Gradio.py`（可選使用）
- 所有測試版本已清理
- 文檔已整合到此文件

