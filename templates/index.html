<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡é¢¨æ ¼è½‰æ›å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px 20px 80px 20px; /* åº•éƒ¨ç•™ç©ºçµ¦é€²åº¦æ¢ */
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #a0a0a0;
            font-size: 1.1rem;
        }
        
        /* ç¸½é«”é€²åº¦æ¢ - å›ºå®šåœ¨åº•éƒ¨ */
        .overall-progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            padding: 0 30px;
            gap: 20px;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        
        .progress-label {
            font-size: 0.9rem;
            color: #a0a0a0;
            min-width: 100px;
        }
        
        .overall-progress {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .overall-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
        }
        
        .overall-progress-text {
            font-size: 1rem;
            color: #00f2fe;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* å·¦å´ï¼šä¸Šå‚³å€ */
        .left-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            position: relative;
            height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .upload-area.drag-over {
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
        }
        
        #preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .upload-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* å³å´ï¼šçµæœå€ */
        .right-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        /* åœ–ç‰‡å®¹å™¨ï¼ˆå¸¶ç‹€æ…‹ç–ŠåŠ ï¼‰ */
        .image-container {
            position: relative;
            background: repeating-conic-gradient(#2a2a2a 0% 25%, #1a1a1a 0% 50%) 50% / 20px 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #result-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        /* ç‹€æ…‹ç–ŠåŠ å±¤ï¼ˆåœ¨åœ–ç‰‡å…§éƒ¨ï¼‰ */
        .status-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            font-size: 1rem;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        /* è™•ç†æ­¥é©Ÿè©³æƒ… */
        .steps-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00f2fe;
        }
        
        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .step {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }
        
        .step.pending {
            opacity: 0.5;
            border-left-color: #555;
        }
        
        .step.active {
            border-left-color: #00f2fe;
            background: rgba(0, 242, 254, 0.15);
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.2);
        }
        
        .step.completed {
            border-left-color: #4caf50;
            opacity: 0.8;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .step-name {
            font-size: 1rem;
        }
        
        .step-percentage {
            font-size: 0.9rem;
            color: #00f2fe;
        }
        
        .step-message {
            font-size: 0.9rem;
            color: #c0c0c0;
            margin-top: 5px;
        }
        
        /* å­æ­¥é©Ÿ */
        .substeps {
            margin-top: 10px;
            padding-left: 20px;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .substep {
            padding: 8px 0;
            font-size: 0.85rem;
            color: #b0b0b0;
        }
        
        .substep.active {
            color: #00f2fe;
            font-weight: bold;
        }
        
        .substep.completed {
            color: #4caf50;
        }
        
        /* æ­¥é©Ÿå…§é€²åº¦æ¢ */
        .step-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.3s ease;
        }
        
        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        /* è¼‰å…¥å‹•ç•« */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ åœ–ç‰‡é¢¨æ ¼è½‰æ›å·¥å…·</h1>
        <p class="subtitle">å°‡äººç‰©ç…§ç‰‡è½‰æ›ç‚ºå‘é‡æ’ç•«é¢¨æ ¼ï¼šåŠå¯«å¯¦ä¼æ¥­é ­åƒ + é€æ˜èƒŒæ™¯</p>
    </div>
    
    
    <div class="container">
        <!-- å·¦å´ï¼šä¸Šå‚³å€ -->
        <div class="left-panel">
            <h2 style="margin-bottom: 20px;">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</h2>
            
            <div class="upload-area" id="upload-area">
                <div id="upload-placeholder">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“</div>
                    <p style="font-size: 1.1rem; margin-bottom: 10px;">é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°æ­¤è™•</p>
                    <p style="font-size: 0.9rem; color: #888;">æ”¯æŒ JPG, PNG æ ¼å¼</p>
                </div>
                <img id="preview-image" style="display: none;">
                <!-- æ¸…é™¤æŒ‰éˆ•ï¼ˆå›ºå®šåœ¨å¤–æ¡†å³ä¸Šè§’ï¼‰ -->
                <button id="clear-image-btn" class="clear-image-button" onclick="clearImage(event)">âœ•</button>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>
            
            <button class="upload-button" id="process-button" disabled>
                ğŸš€ é–‹å§‹è½‰æ›
            </button>
        </div>
        
        <!-- å³å´ï¼šçµæœå’Œæ­¥é©Ÿ -->
        <div class="right-panel">
            <h2 style="margin-bottom: 20px;">ğŸ–¼ï¸ è™•ç†çµæœ</h2>
            
            <!-- åœ–ç‰‡å®¹å™¨ï¼ˆç‹€æ…‹ç–ŠåŠ åœ¨å…§éƒ¨ï¼‰ -->
            <div class="image-container">
                <img id="result-image" src="" alt="è™•ç†çµæœ" style="display: none;">
                <div style="color: #666; font-size: 1.2rem;" id="empty-state">
                    ç­‰å¾…ä¸Šå‚³åœ–ç‰‡...
                </div>
                
                <!-- ç‹€æ…‹ç–ŠåŠ å±¤ï¼ˆåœ¨åœ–ç‰‡å…§éƒ¨ï¼‰ -->
                <div class="status-overlay" id="status-overlay" style="display: none;">
                    ç­‰å¾…é–‹å§‹...
                </div>
                
                <!-- ä¸‹è¼‰æŒ‰éˆ•ï¼ˆåœ¨åœ–ç‰‡å³ä¸Šè§’ï¼‰ -->
                <div id="download-area" style="position: absolute; top: 15px; right: 15px; display: none; gap: 10px;">
                    <button onclick="downloadImage()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: transform 0.2s;">
                        ğŸ“¥ ä¸‹è¼‰
                    </button>
                </div>
            </div>
            
            <!-- è™•ç†æ­¥é©Ÿè©³æƒ… -->
            <div class="steps-title">ğŸ“‹ è™•ç†æ­¥é©Ÿè©³æƒ…</div>
            <div class="steps-container" id="steps-container">
                <!-- æ­¥é©Ÿæœƒå‹•æ…‹å‰µå»º -->
            </div>
        </div>
    </div>
    
    <!-- ç¸½é«”é€²åº¦æ¢ - å›ºå®šåœ¨åº•éƒ¨ -->
    <div class="overall-progress-bar">
        <div class="progress-label">ğŸ“Š ç¸½é«”é€²åº¦</div>
        <div class="overall-progress">
            <div class="overall-progress-fill" id="overall-progress" style="width: 0%"></div>
        </div>
        <div class="overall-progress-text" id="overall-progress-text">0%</div>
    </div>
    
    <script>
        let ws = null;
        let currentImage = null;
        
        // åˆå§‹åŒ–ä¸Šå‚³å€åŸŸ
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const previewImage = document.getElementById('preview-image');
        const processButton = document.getElementById('process-button');
        
        uploadArea.addEventListener('click', (e) => {
            // é¿å…åœ¨é»æ“Šé è¦½åœ–ç‰‡æˆ–æ¸…é™¤æŒ‰éˆ•æ™‚è§¸ç™¼
            if (e.target === uploadArea || e.target === document.getElementById('upload-placeholder')) {
                fileInput.click();
            }
        });
        
        // æ–‡ä»¶é¸æ“‡
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            console.log('æ–‡ä»¶é¸æ“‡:', file ? file.name : 'ç„¡');
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImage = e.target.result;
                    console.log('âœ… åœ–ç‰‡å·²è®€å–ï¼Œé•·åº¦:', currentImage.length);
                    
                    // åœ¨ä¸Šå‚³å€åŸŸé¡¯ç¤ºé è¦½
                    previewImage.src = currentImage;
                    previewImage.style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                    document.getElementById('clear-image-btn').classList.add('show');
                    
                    // å•Ÿç”¨æŒ‰éˆ•
                    console.log('æŒ‰éˆ•å•Ÿç”¨å‰:', processButton.disabled);
                    processButton.disabled = false;
                    console.log('æŒ‰éˆ•å•Ÿç”¨å¾Œ:', processButton.disabled);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // æ¸…é™¤åœ–ç‰‡
        function clearImage(event) {
            if (event) event.stopPropagation(); // é˜²æ­¢è§¸ç™¼ä¸Šå‚³å€åŸŸçš„é»æ“Šäº‹ä»¶
            currentImage = null;
            previewImage.src = '';
            previewImage.style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'block';
            document.getElementById('clear-image-btn').classList.remove('show');
            fileInput.value = '';
            processButton.disabled = true;
            console.log('åœ–ç‰‡å·²æ¸…é™¤ï¼ŒæŒ‰éˆ•å·²ç¦ç”¨');
            
            // æ¸…ç©ºçµæœå€
            document.getElementById('result-image').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('status-overlay').style.display = 'none';
            document.getElementById('download-area').style.display = 'none';
        }
        
        // ä¸‹è¼‰åœ–ç‰‡
        function downloadImage() {
            const img = document.getElementById('result-image');
            if (img.src) {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = 'result_' + Date.now() + '.png';
                link.click();
            }
        }
        
        // æ‹–æ”¾ä¸Šå‚³
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImage = e.target.result;
                    // åœ¨ä¸Šå‚³å€åŸŸé¡¯ç¤ºé è¦½
                    previewImage.src = currentImage;
                    previewImage.style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                    document.getElementById('clear-image-btn').style.display = 'block';
                    processButton.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // é–‹å§‹è™•ç†
        processButton.addEventListener('click', startProcessing);
        
        function startProcessing() {
            if (!currentImage) return;
            
            processButton.disabled = true;
            processButton.textContent = 'â³ è™•ç†ä¸­...';
            
            // æ¸…ç©ºæ­¥é©Ÿå®¹å™¨
            document.getElementById('steps-container').innerHTML = '';
            
            // é€£æ¥ WebSocketï¼ˆè‡ªå‹•ä½¿ç”¨ç•¶å‰é é¢çš„ç«¯å£ï¼‰
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/process`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({ image: currentImage }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
            
            ws.onclose = () => {
                processButton.disabled = false;
                processButton.textContent = 'ğŸš€ é–‹å§‹è½‰æ›';
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket éŒ¯èª¤:', error);
                alert('é€£æ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                processButton.disabled = false;
                processButton.textContent = 'ğŸš€ é–‹å§‹è½‰æ›';
            };
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'image':
                    updateImage(data.image, data.message);
                    break;
                case 'step_start':
                    createStep(data.step_id, data.step_name, data.substeps);
                    updateStep(data.step_id, 'active', data.step_progress, data.message);
                    updateOverallProgress(data.overall_progress);
                    updateStatusOverlay(data.message);
                    break;
                case 'step_update':
                    updateStep(data.step_id, 'active', data.step_progress, data.message);
                    updateOverallProgress(data.overall_progress);
                    updateStatusOverlay(data.message);
                    break;
                case 'step_complete':
                    updateStep(data.step_id, 'completed', 100, data.message);
                    updateOverallProgress(data.overall_progress);
                    updateStatusOverlay(data.message);
                    if (data.image) updateImage(data.image, data.message);
                    break;
                case 'substep_start':
                case 'substep_update':
                    updateSubstep(data.step_id, data.substep_id, 'active', data.message);
                    updateStep(data.step_id, 'active', data.step_progress, data.message);
                    updateOverallProgress(data.overall_progress);
                    updateStatusOverlay(data.message);
                    break;
                case 'substep_complete':
                    updateSubstep(data.step_id, data.substep_id, 'completed', data.message);
                    updateStep(data.step_id, 'active', data.step_progress, data.message);
                    updateOverallProgress(data.overall_progress);
                    if (data.image) updateImage(data.image, data.message);
                    updateStatusOverlay(data.message);
                    break;
                case 'complete':
                    updateImage(data.image, data.message);
                    updateStatusOverlay(data.message);
                    updateOverallProgress(100);
                    document.getElementById('download-area').style.display = 'block';
                    processButton.disabled = false;
                    processButton.textContent = 'âœ… è™•ç†å®Œæˆ';
                    setTimeout(() => {
                        processButton.textContent = 'ğŸš€ é‡æ–°è½‰æ›';
                    }, 2000);
                    break;
                case 'error':
                    alert('è™•ç†å¤±æ•—: ' + data.message);
                    updateStatusOverlay('âŒ ' + data.message);
                    processButton.disabled = false;
                    processButton.textContent = 'ğŸš€ é–‹å§‹è½‰æ›';
                    break;
            }
        }
        
        function createStep(stepId, stepName, substeps) {
            const container = document.getElementById('steps-container');
            
            if (!document.getElementById(`step-${stepId}`)) {
                const stepDiv = document.createElement('div');
                stepDiv.id = `step-${stepId}`;
                stepDiv.className = 'step pending';
                stepDiv.innerHTML = `
                    <div class="step-header">
                        <span class="step-name">âšª æ­¥é©Ÿ ${stepId}: ${stepName}</span>
                        <span class="step-percentage">0%</span>
                    </div>
                    <div class="step-progress-bar">
                        <div class="step-progress-fill" id="progress-${stepId}" style="width: 0%"></div>
                    </div>
                    <div class="step-message" id="message-${stepId}">ç­‰å¾…ä¸­...</div>
                    <div class="substeps" id="substeps-${stepId}"></div>
                `;
                container.appendChild(stepDiv);
                
                // å‰µå»ºå­æ­¥é©Ÿ
                if (substeps && substeps.length > 0) {
                    const substepsContainer = document.getElementById(`substeps-${stepId}`);
                    substeps.forEach((substep, index) => {
                        const substepDiv = document.createElement('div');
                        substepDiv.id = `substep-${stepId}-${index + 1}`;
                        substepDiv.className = 'substep pending';
                        substepDiv.textContent = `âšª ${stepId}.${index + 1} ${substep}`;
                        substepsContainer.appendChild(substepDiv);
                    });
                }
            }
        }
        
        function updateStep(stepId, status, progress, message) {
            const stepDiv = document.getElementById(`step-${stepId}`);
            if (!stepDiv) return;
            
            stepDiv.className = `step ${status}`;
            
            const icon = status === 'completed' ? 'âœ…' : status === 'active' ? 'â³' : 'âšª';
            const nameEl = stepDiv.querySelector('.step-name');
            const originalName = nameEl.textContent.split(':')[1] || nameEl.textContent;
            nameEl.textContent = `${icon} æ­¥é©Ÿ ${stepId}:${originalName}`;
            
            stepDiv.querySelector('.step-percentage').textContent = Math.round(progress) + '%';
            stepDiv.querySelector(`#progress-${stepId}`).style.width = progress + '%';
            stepDiv.querySelector(`#message-${stepId}`).textContent = message;
        }
        
        function updateSubstep(stepId, substepId, status, message) {
            const substepDiv = document.getElementById(`substep-${stepId}-${substepId}`);
            if (!substepDiv) return;
            
            substepDiv.className = `substep ${status}`;
            const icon = status === 'completed' ? 'âœ…' : status === 'active' ? 'â³' : 'âšª';
            const text = substepDiv.textContent.split(' ').slice(1).join(' ');
            substepDiv.textContent = `${icon} ${text}`;
        }
        
        function updateImage(imageData, message) {
            const imgEl = document.getElementById('result-image');
            const emptyState = document.getElementById('empty-state');
            imgEl.src = imageData;
            imgEl.style.display = 'block';
            emptyState.style.display = 'none';
            
            const overlay = document.getElementById('status-overlay');
            overlay.style.display = 'block';
        }
        
        function updateStatusOverlay(message) {
            document.getElementById('status-overlay').textContent = message;
        }
        
        function updateOverallProgress(progress) {
            const progressFill = document.getElementById('overall-progress');
            const progressText = document.getElementById('overall-progress-text');
            const percentage = Math.round(progress);
            progressFill.style.width = percentage + '%';
            progressText.textContent = `ç¸½é«”é€²åº¦ï¼š${percentage}%`;
        }
    </script>
</body>
</html>

